{% extends 'base.html' %}

{% block title %}Абакус{% endblock %}

{% block game %}
Игра "Флешкарты"
{% endblock %}

{% block mycss %}
<style>
    /* Центровка абакуса */
    .abacus-wrapper {
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }
    
    .abacus-container {
        display: flex;
        gap: 80px;
        padding: 40px;
        background-color: #fdfdfd;
        border-radius: 24px;
        box-shadow: 0 0 24px rgba(0, 0, 0, 0.1);
        position: relative;
    }
    
    .column {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }
    
    .stick {
        width: 8px;
        height: 520px;
        background-color: #333;
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        z-index: 0;
    }
    
    .beads-top, .beads-bottom {
        display: flex;
        flex-direction: column;
        gap: 20px;
        z-index: 1;
    }
    
    .beads-top {
        margin-bottom: 20px;
    }
    
    .beads-bottom {
        margin-top: 0px;
    }
    
    .separator-line {
        position: absolute;
        top: 180px;
        left: 0;
        right: 0;
        height: 8px;
        background-color: #555;
        z-index: 2;
    }
    
    /* Стиль для бусин */
    .bead {
        width: 56px;
        height: 56px;
        transform: rotate(45deg);
        border-radius: 14px;
        background: transparent;
        border: 4px solid transparent;
        transition: all 0.3s ease;
        position: relative;
    }
    
    /* Активное состояние для бусин */
    .bead.active {
        background: linear-gradient(145deg, #f6b73c, #d9822b);
        border-color: #aa6708;
        box-shadow: inset 4px 4px 8px rgba(255, 255, 255, 0.3), inset -4px -4px 8px rgba(0, 0, 0, 0.2), 4px 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    /* Добавим эффект света на бусины */
    .bead.active::before {
        content: "";
        position: absolute;
        top: 10px;
        left: 10px;
        width: 50%;
        height: 50%;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        transform: rotate(-45deg);
    }
    
    /* Кнопка повторить */
    .retry-button {
        padding: 24px 48px;
        font-size: 36px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 16px;
        cursor: pointer;
        box-shadow: 0 8px 12px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .retry-button:hover {
        background-color: #45a049;
        transform: translateY(-4px);
    }
</style>
{% endblock %}

{% block content %}
{% if mode == 1 %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-5">
            <h5>
                Выберите уровень игры:<br>
                - сложность<br>
                - скорость<br>
                - количество примеров<br>
                - цифры, из которых будут состоять числа<br>
            </h5>
        </div>
        <div class="col-7">
            <h6>
                Игра "Флешкарты" для тренировки навыков счета с Абакусом. 
                Время — интервал в секундах, количество примеров = чисел, 
                выбор цифры — ограничение до максимальной цифры.
            </h6>
        </div>
    </div>
    
    <form action="{% url 'flashcards' mode=1 %}" method="post" class="mt-5">
        {% csrf_token %}
        <div class="row justify-content-center">
            <div class="col-3">
                <label for="difficult" class="form-label">Сложность: <span id="difficult-value">1</span></label>
                <input type="range" class="form-range" id="difficult" name="difficult" min="1" max="4" value="1" step="1">
                <script>
                    const slider = document.getElementById("difficult");
                    const output = document.getElementById("difficult-value");
                    slider.addEventListener("input", () => updateRangeDisplay(slider.value));
                    function updateRangeDisplay(value) {
                        const ranges = ["1–10", "10–100", "100–1000", "1000–10000"];
                        output.textContent = ranges[value - 1] || value;
                    }
                    updateRangeDisplay(slider.value);
                </script>
            </div>
            <div class="col-3">
                <label for="speed" class="form-label">Скорость: <span id="speed-value">1</span> сек</label>
                <input type="range" class="form-range" id="speed" name="speed" min="0.1" max="10" step="0.1" value="1">
                <script>
                    const speedInput = document.getElementById('speed');
                    const speedValue = document.getElementById('speed-value');
                    speedInput.addEventListener('input', () => {
                        speedValue.textContent = parseFloat(speedInput.value).toFixed(1);
                    });
                </script>
            </div>
            <div class="col-3">
                <label for="quantity" class="form-label">Количество примеров: <span id="quantity-value">2</span></label>
                <input type="range" class="form-range" id="quantity" name="quantity" min="2" max="99" step="1" value="2">
                <script>
                    const quantityInput = document.getElementById('quantity');
                    const quantityValue = document.getElementById('quantity-value');
                    quantityInput.addEventListener('input', () => {
                        quantityValue.textContent = quantityInput.value;
                    });
                </script>
            </div>
            <div class="col-3">
                <label for="max_digit" class="form-label">Максимальная цифра: <span id="max_digit-value">2</span></label>
                <input type="range" class="form-range" id="max_digit" name="max_digit" min="2" max="9" step="1" value="2">
                <script>
                    const maxDigitInput = document.getElementById('max_digit');
                    const maxDigitValue = document.getElementById('max_digit-value');
                    maxDigitInput.addEventListener('input', () => {
                        maxDigitValue.textContent = maxDigitInput.value;
                    });
                </script>
            </div>
        </div>
        <div class="row justify-content-center mt-4">
            <button type="submit" class="btn btn-primary btn-sm w-25">Начать</button>
        </div>
    </form>
</div>

{% elif mode == 2 %}
<div class="abacus-wrapper">
    <div id="abacus-display">
        {% for columns in columns_list %}
        <div class="abacus-set" style="display: none;">
            <div class="abacus-container">
                <div class="separator-line"></div>
                {% for column in columns %}
                <div class="column">
                    <div class="stick"></div>
                    <div class="beads-top">
                        {% for bead in column.0 %}
                        <div class="bead {% if bead == 1 %}active{% endif %}"></div>
                        {% endfor %}
                    </div>
                    <div class="beads-bottom">
                        {% for bead in column.1 %}
                        <div class="bead {% if bead == 1 %}active{% endif %}"></div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div id="retry-section" style="display: none; text-align: center; margin-top: 40px;">
    <form method="get">
        <button type="submit" class="retry-button">Попробовать снова</button>
    </form>
</div>

<!-- Звук абакуса -->
<audio id="abacus-sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const abacusSets = document.querySelectorAll('.abacus-set');
        const speed = {{ speed|safe }} * 1000;
        const sound = document.getElementById('abacus-sound');
        let index = 0;
        
        function tryPlaySound() {
            sound.currentTime = 0;
            sound.play().catch(() => {
                console.log('Автозвук заблокирован. Ждём клик пользователя.');
                document.addEventListener('click', function once() {
                    sound.play();
                    document.removeEventListener('click', once);
                });
            });
        }
        
        if (abacusSets.length > 0) {
            abacusSets[0].style.display = 'flex';
            abacusSets[0].style.justifyContent = 'center';
            
            const showNext = () => {
                abacusSets[index].style.display = 'none';
                index++;
                
                if (index < abacusSets.length) {
                    abacusSets[index].style.display = 'flex';
                    abacusSets[index].style.justifyContent = 'center';
                    tryPlaySound();
                    setTimeout(showNext, speed);
                } else {
                    document.getElementById('retry-section').style.display = 'block';
                }
            };
            
            setTimeout(showNext, speed);
        }
    });
</script>
{% endif %}
{% endblock %}